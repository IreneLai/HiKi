{% extends 'diary/diary-form.html' %}
{% load static %}

{% block title %}
	Edit Diary
{% endblock %}

{% block init %}
<script type="text/javascript">
//init ============================================
function init() {
  var obj = document.getElementById("tag");
  {% for tag in editTag %}
    var newElement = document.createElement("div");
    newElement.name = '{{tag.tagName}}';
    newElement.innerHTML = "#" + '{{tag.tagName}}';
    newElement.classList.add("mr-2");
	newElement.classList.add("h4");
    newElement.style = "display:inline;";
	newElement.setAttribute("onmouseover", ' this.style = "text-decoration:line-through;display:inline;"');
	newElement.setAttribute("onmouseout", ' this.style = "text-decoration:none;display:inline;"');
	newElement.setAttribute("ondblclick", 'this.parentNode.removeChild(this);');
    //最後再使用appendChild加到要加的元素裡
    obj.appendChild(newElement);
    document.getElementById("tagValue").value = "";
  {% endfor %}
};
addEventListener('load', init, false);
</script>

<script>
function initMap() {
	var latitude = {{editMap.latitude}};
	var longitude = {{editMap.longitude}};
	var location = '{{editMap.location}}';
	var default_zoon =9;
	var map = new google.maps.Map(document.getElementById('map'), {
	  center: {lat: latitude, lng: longitude}, //taiwan
	  zoom: default_zoon,
	  mapTypeId: 'roadmap'
	});
	var input = document.getElementById('pac-input');
	input.placeholder = location;
	var searchBox = new google.maps.places.SearchBox(input);
	map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
	map.addListener('bounds_changed', function() {
	  searchBox.setBounds(map.getBounds());
	});
	var markers = [];
	var markMap = function() {
		console.log(searchBox)
		var places = searchBox.getPlaces(); //得到輸入位置
		if (places.length == 0) {
			return;
		}
		markers.forEach(function(marker) {
			marker.setMap(null);
		});
		markers = [];
		var bounds = new google.maps.LatLngBounds();
		places.forEach(function(place) {
		if (!place.geometry) {
			console.log("Returned place contains no geometry");
			return;
		}
	    location = input.value;
	    latitude = place.geometry.location.lat();
	    longitude = place.geometry.location.lng();
	    document.getElementById("latitude").value = latitude;
	    document.getElementById("longitude").value = longitude;
	    document.getElementById("location").value = location;
	    //圖示
	    var icon = {
			url:"{% static 'icon/mapflag.png' %}",
			size: new google.maps.Size(71, 71),
			origin: new google.maps.Point(0, 0),
			anchor: new google.maps.Point(17, 34),
			scaledSize: new google.maps.Size(40, 40)
	    };

	    markers.push(new google.maps.Marker({
	        map: map,
	        icon: icon,
	        title: place.name,
	        position: place.geometry.location
	        }));
	        if (place.geometry.viewport) {
	        	bounds.union(place.geometry.viewport);
	        } else {
	        	bounds.extend(place.geometry.location);
	        }
	    });
	  map.fitBounds(bounds);
	};
	searchBox.addListener('load', markMap );
	searchBox.addListener('places_changed', markMap );
}
</script>

<script src="https://maps.googleapis.com/maps/api/js?key={{MapAPI}}&libraries=places&language=zh-TW&callback=initMap" async defer></script>
{% endblock %}

{% block nav %}
	{% include 'users/nav.html' with name='Edit Diary' %}
{% endblock %}